@using AppPerfumaria.Api.ReinoCompany
@using AppPerfumaria.Components.CmpsGerais
@using AppPerfumaria.Components.Pages.TiposUsuarios.Cmp
@using AppPerfumaria.Exceptions
@using AppPerfumaria.Models.Auth
@using System.Text.Json.Serialization
@using AppPerfumaria.Models.Collections
@using AppPerfumaria.Models.Pagination
@using AppPerfumaria.Models.Tables

@inject IDialogService Dialog
@inject ExceptionService ExceptionService
@inject ISnackbar Snack

<MudOverlay DarkBackground Visible="_carregando" ZIndex="10">
    <MudProgressCircular Indeterminate="true" Color="Color.Default" />
</MudOverlay>

<MudPaper Class="px-2 w-100" Elevation="4" Style="position:fixed; z-index: 9;">
    <!-- Barra de pesquisa e botão filtro -->
    <div class="d-flex">
        <MudTextField Value="_pesquisarFiltro" Label="Pesquisar" Variant="Variant.Outlined"
                      Adornment="Adornment.End" Margin="Margin.Dense" Immediate="true" 
                      ValueChanged="(async (string v) => { _pesquisarFiltro = v; await Pesquisar(v); })"
                      AdornmentIcon="@Icons.Material.Filled.Search" AdornmentColor="Color.Inherit" 
                      ClearIcon="@Icons.Material.Filled.Clear" Clearable="true" />
        <MudSpacer />
        <MudIconButton Icon="@Icons.Material.Filled.FilterList" OnClick="Filtro"
                        Color="Color.Inherit" Size="Size.Medium" />
    </div>
    <!-- Barra de filtros -->
    <MudPopover Open="@_exibirFiltro" Fixed="true" Class="px-4 pt-4 w-100" 
                AnchorOrigin="Origin.TopRight" TransformOrigin="Origin.TopRight" >
        <MudGrid Spacing="2" Justify="Justify.Center" Class="mb-1">
            <MudItem xs="6">
                <MudSelect @bind-Value="_porPagina" Variant="Variant.Outlined"
                            Label="Carregar De" Margin="Margin.Dense">
                    <MudSelectItem Value="@("10")" />
                    <MudSelectItem Value="@("15")" />
                    <MudSelectItem Value="@("20")" />
                </MudSelect>
            </MudItem>
            <MudItem xs="6">
                <MudSelect T="string" @bind-Value="_statusFiltro" Variant="Variant.Outlined"
                            Label="Status" Margin="Margin.Dense">
                    <MudSelectItem Value="@("Todos")" />
                    <MudSelectItem Value="@("Ativo")" />
                    <MudSelectItem Value="@("Inativo")" />
                </MudSelect>
            </MudItem>
        </MudGrid>
        <MudDivider />
        <div class="d-flex my-2 float-end">
            <MudFab Label="Fechar" Size="Size.Small" 
                    OnClick="Filtro" Class="mr-2" />
            <MudFab Label="Filtrar" Size="Size.Small" 
                    OnClick="AplicarFiltros" />
        </div>
    </MudPopover>
    <!-- Barra de card e botão criar -->
    <div class="d-flex">
        <MudTabs Elevation="4" Rounded="true" Centered="true" @ref="tabs">
            <MudTabPanel Text="Tipos Usuários" OnClick="@(() => LimparEListarTiposUsers())" />
            <MudTabPanel Text="Permissões" OnClick="@(() => LimparEListarPermissoes())" />
        </MudTabs>
        <MudSpacer />
        @if (_indiceMenu == 0)
        {
            <MudIconButton Icon="@Icons.Material.Filled.Add" OnClick="CriarTipoUsuario"
                           Color="Color.Inherit" Size="Size.Medium" />
        }
        else if (_indiceMenu == 1)
        {
            <MudIconButton Icon="@Icons.Material.Filled.Add" OnClick="CriarPermissao"
                           Color="Color.Inherit" Size="Size.Medium" />
        }
    </div>
</MudPaper>

<div class="pa-2" style="margin-top: 100px;">
    @if (_indiceMenu == 0)
    {
        <!-- Listar resultados dos tipos de usuários -->
        <Tabela TypeItem="TiposUsers" ListItens="_listarTiposUsers" Pagination="_paginacaoTiposUsers" OnClickPage="CarregarMais" Carregando="_carregando">
            <Head>
                <th>Tipo</th>
                <th class="text-center">Ação</th>
            </Head>
            <Body>
                <td>@context.tipo</td>
                <td class="text-center">
                    <MudIconButton Size="Size.Small" OnClick="@(() => AtualizarTipoUsuario(context))"
                                       Icon="@Icons.Material.Filled.Edit" />
                    <MudIconButton Size="Size.Small" OnClick="@(() => DeletarTipoUsuario(context))"
                                       Icon="@Icons.Material.Filled.Delete" />
                </td>
            </Body>
            <Footer>
                <td>Tipo</td>
                <td class="text-center">Ação</td>
            </Footer>
        </Tabela>

    }
    else if (_indiceMenu == 1)
    {
        <!-- Listar resultados das permissões -->
        <Tabela TypeItem="Permissoes" ListItens="_listarPermissoes" Pagination="_paginacaoPermissoes" OnClickPage="CarregarMais" Carregando="_carregando">
            <Head>
                <th>Permissão</th>
                <th class="text-center">Grupo</th>
                <th class="text-center">Ação</th>
            </Head>
            <Body>
                <td class="@("fw-bold " + (context.status == "Ativo" ? "text-success" : "text-danger"))">@context.chave</td>
                <td class="text-center">@context.grupo</td>
                <td class="text-center">
                    <MudIconButton Size="Size.Small" OnClick="@(() => AtualizarPermissao(context))"
                                       Icon="@Icons.Material.Filled.Edit" />
                    <MudIconButton Size="Size.Small" OnClick="@(() => DeletarPermissao(context))"
                                       Icon="@Icons.Material.Filled.Delete" />
                </td>
            </Body>
            <Footer>
                <td>Permissão</td>
                <td class="text-center">Grupo</td>
                <td class="text-center">Ação</td>
            </Footer>
        </Tabela>
    }
</div>

@code {
    [Parameter] public Auth? Auth { get; set; }
    [Parameter] public Instalacoes? Instalacao { get; set; }
    private List<TiposUsers>? _listarTiposUsers = new List<TiposUsers>();
    private List<Permissoes>? _listarPermissoes = new List<Permissoes>();
    private MetaPagination? _paginacaoTiposUsers;
    private MetaPagination? _paginacaoPermissoes;
    private MudTabs? tabs;
    private int _indiceMenu = 0;
    private bool _carregando = true;
    private bool _exibirFiltro = false;
    private string? _pesquisarFiltro;
    private string? _statusFiltro = "Todos";
    private DateRange _dataCriacaoFiltro = new DateRange();
    private string _porPagina = "10";
    private int _paginaPaginacao = 1;

    protected override async Task OnInitializedAsync()
    {
        do
        {
            await Task.Delay(300);
        }
        while (Auth == null || Instalacao == null);

        await ListarTiposUsers();
    }

    private async Task Pesquisar(string pesquisar)
    {
        await Task.Delay(1500);

        if (pesquisar == _pesquisarFiltro)
        {
            await AplicarFiltros();
        }
    }

    public async Task CarregarMais(int paginaPaginacao)
    {
        if (_indiceMenu == 0)
        {
            _paginaPaginacao = paginaPaginacao;
            _listarTiposUsers = new List<TiposUsers>();
            await ListarTiposUsers();
        }
        else
        {
            _paginaPaginacao = paginaPaginacao;
            _listarPermissoes = new List<Permissoes>();
            await ListarPermissoes();
        }
    }

    private void Filtro()
    {
        _exibirFiltro = !_exibirFiltro;
    }

    public string? PegarFiltros()
    {
        string filtros = $"?page={_paginaPaginacao}&por_pagina={_porPagina}";

        if (!string.IsNullOrEmpty(_pesquisarFiltro))
        {
            filtros += $"&pesquisar={_pesquisarFiltro}";
        }
        if (!string.IsNullOrEmpty(_statusFiltro) && _statusFiltro != "Todos")
        {
            filtros += $"&status={_statusFiltro}";
        }

        return filtros;
    }

    public async Task AplicarFiltros()
    {
        _exibirFiltro = false;

        if (_indiceMenu == 0)
        {
            await LimparEListarTiposUsers();
        }
        else
        {
            await LimparEListarPermissoes();
        }
    }

    public async Task LimparEListarTiposUsers(int pagina = 1)
    {
        _paginaPaginacao = pagina;
        _listarTiposUsers = new List<TiposUsers>();
        await ListarTiposUsers();
    }

    public async Task ListarTiposUsers()
    {
        try
        {
            _carregando = true;
            StateHasChanged();
            string? filtros = PegarFiltros();

            var reinoCompany = new ReinoCompany();
            var response = await reinoCompany.TiposUsersListar(Auth!.token!, filtros);

            if (response!.status)
            {
                _paginacaoTiposUsers = response.meta;
                _listarTiposUsers!.AddRange(response!.data!);
            }
            else
            {
                if (!string.IsNullOrEmpty(response.message))
                {
                    Snack.Add(response.message, Severity.Warning);
                }
            }

            _indiceMenu = 0;
            _carregando = false;
            StateHasChanged();
        }
        catch (Exception e)
        {
            ExceptionService.HandleAsync(e, "Tivemos um problema ao tentar listar os tipos de usuários!");
            _carregando = false;
        }
    }

    public async Task LimparEListarPermissoes(int pagina = 1)
    {
        _paginaPaginacao = pagina!;
        _listarPermissoes = new List<Permissoes>();
        await ListarPermissoes();
    }

    public async Task ListarPermissoes()
    {
        try
        {
            _carregando = true;
            StateHasChanged();
            string? filtros = PegarFiltros();

            var reinoCompany = new ReinoCompany();
            var response = await reinoCompany.PermissoesListar(Auth!.token!, filtros);

            if (response!.status)
            {
                _paginacaoPermissoes = response.meta;
                _listarPermissoes!.AddRange(response!.data!);
            }
            else
            {
                if (!string.IsNullOrEmpty(response.message))
                {
                    Snack.Add(response.message, Severity.Warning);
                }
            }

            _indiceMenu = 1;
            _carregando = false;
            StateHasChanged();
        }
        catch (Exception e)
        {
            ExceptionService.HandleAsync(e, "Tivemos um problema ao tentar listar as marcas!");
            _carregando = false;
        }
    }

    public async Task CriarTipoUsuario()
    {
        try
        {
            var options = new DialogOptions
            {
                MaxWidth = MaxWidth.ExtraExtraLarge,
                FullWidth = true,
                BackdropClick = false,
                CloseButton = true,
                Position = DialogPosition.TopCenter
            };
            var param = new DialogParameters { ["_tipoUserForm"] = new TiposUsers() };
            var dialog = Dialog.Show<TiposUsuariosFormCmp>("Adicionar Tipo Usuário", param, options);
            var result = await dialog.Result;
            if (!result.Canceled)
            {
                Snack.Add("Tipo de usuário criado com sucesso!", Severity.Success);
                await LimparEListarTiposUsers(_paginaPaginacao);
            }
        }
        catch (Exception e)
        {
            ExceptionService.HandleAsync(e, "Tivemos um problema ao tentar criar o tipo de usuário!");
            _carregando = false;
        }
    }

    public async Task CriarPermissao()
    {
        try
        {
            var options = new DialogOptions { 
                    MaxWidth = MaxWidth.ExtraExtraLarge, 
                    FullWidth = true, 
                    BackdropClick = false, 
                    CloseButton = true, 
                    Position = DialogPosition.TopCenter 
            };
            var param = new DialogParameters { ["_permissaoForm"] = new Permissoes() };
            var dialog = Dialog.Show<PermissoesFormCmp>("Adicionar Permissão", param, options);
            var result = await dialog.Result;
            if (!result.Canceled)
            {
                Snack.Add("Permissão criada com sucesso!", Severity.Success);
                await LimparEListarPermissoes(_paginaPaginacao);
            }
        }
        catch (Exception e)
        {
            ExceptionService.HandleAsync(e, "Tivemos um problema ao tentar criar a permissão!");
            _carregando = false;
        }
    }

    public async Task AtualizarTipoUsuario(TiposUsers tipoUser)
    {
        try
        {
            var options = new DialogOptions
                {
                    MaxWidth = MaxWidth.ExtraExtraLarge,
                    FullWidth = true,
                    BackdropClick = false,
                    CloseButton = true,
                    Position = DialogPosition.TopCenter
                };
            var param = new DialogParameters { ["_tipoUserForm"] = tipoUser.Clone() };
            var dialog = Dialog.Show<TiposUsuariosFormCmp>("Atualizar Tipo Usuário", param, options);
            var result = await dialog.Result;
            if (!result.Canceled)
            {
                tipoUser = (TiposUsers)result.Data;
                var index = _listarTiposUsers.FindIndex(ip => ip.id == tipoUser!.id);
                if (index != -1)
                {
                    _listarTiposUsers[index] = tipoUser!;
                }
                Snack.Add("Tipo de usuário atualizado com sucesso!", Severity.Success);
                StateHasChanged();
            }
        }
        catch (Exception e)
        {
            ExceptionService.HandleAsync(e, "Tivemos um problema ao tentar atualizar o tipo de usuário!");
            _carregando = false;
        }
    }

    public async Task AtualizarPermissao(Permissoes permissao)
    {
        try
        {
            var options = new DialogOptions
                {
                    MaxWidth = MaxWidth.ExtraExtraLarge,
                    FullWidth = true,
                    BackdropClick = false,
                    CloseButton = true,
                    Position = DialogPosition.TopCenter
                };
            var param = new DialogParameters { ["_permissaoForm"] = permissao.Clone() };
            var dialog = Dialog.Show<PermissoesFormCmp>("Atualizar Permissão", param, options);
            var result = await dialog.Result;
            if (!result.Canceled)
            {
                permissao = (Permissoes)result.Data;
                var index = _listarPermissoes.FindIndex(ip => ip.id == permissao!.id);
                if (index != -1)
                {
                    _listarPermissoes[index] = permissao!;
                }
                Snack.Add("Permissão atualizada com sucesso!", Severity.Success);
                StateHasChanged();
            }
        }
        catch (Exception e)
        {
            ExceptionService.HandleAsync(e, "Tivemos um problema ao tentar atualizar a permissão!");
            _carregando = false;
        }
    }

    public async Task DeletarTipoUsuario(TiposUsers tipoUser)
    {
        try
        {
            var param = new DialogParameters<AlertaDelete>
            {
                { x => x.ContentText, "Tem certeza que deseja deletar esse <b>TIPO DE USUÁRIO</b> e todos os dados a ele ligados?" }
            };
            var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.ExtraSmall };
            var dialog = Dialog.Show<AlertaDelete>("Deletar Tipo Usuário", param, options);
            var result = await dialog.Result;
            if (!result.Canceled)
            {
                _carregando = true;
                var reinoCompany = new ReinoCompany();
                var response = await reinoCompany.TiposUsersDeletar(Auth!.token!, tipoUser);

                if (response!.status)
                {
                    Snack.Add("Tipo de usuário deletado com sucesso!", Severity.Success);
                    await LimparEListarTiposUsers(_paginaPaginacao);
                }
                else
                {
                    if (!string.IsNullOrEmpty(response.message))
                    {
                        Snack.Add(response.message, Severity.Warning);
                    }
                    _carregando = false;
                }
            }
        }
        catch (Exception e)
        {
            ExceptionService.HandleAsync(e, "Tivemos um problema ao tentar deletar o tipo de usuário!");
            _carregando = false;
        }
    }

    public async Task DeletarPermissao(Permissoes permissao)
    {
        try
        {
            var param = new DialogParameters<AlertaDelete>
            {
                { x => x.ContentText, "Tem certeza que deseja deletar essa <b>PERMISSÃO</b> e todos os dados a ela ligados?" }
            };
            var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.ExtraSmall };
            var dialog = Dialog.Show<AlertaDelete>("Deletar Permissão", param, options);
            var result = await dialog.Result;
            if (!result.Canceled)
            {
                _carregando = true;
                var reinoCompany = new ReinoCompany();
                var response = await reinoCompany.PermissoesDeletar(Auth!.token!, permissao);

                if (response!.status)
                {
                    Snack.Add("Permissão deletada com sucesso!", Severity.Success);
                    await LimparEListarPermissoes(_paginaPaginacao);
                }
                else
                {
                    if (!string.IsNullOrEmpty(response.message))
                    {
                        Snack.Add(response.message, Severity.Warning);
                    }
                    _carregando = false;
                }
            }
        }
        catch (Exception e)
        {
            ExceptionService.HandleAsync(e, "Tivemos um problema ao tentar deletar a permissão!");
            _carregando = false;
        }
    }
}
